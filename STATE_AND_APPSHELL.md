# Riverpod, состояние и AppShell

## Riverpod в проекте (простое объяснение)

- **Идея:** это способ хранить данные отдельно от экранов и легко получать их там, где нужно.
- **Как думать:** представьте «склад» с готовыми объектами. Экран приходит и говорит: «дай мне текущего пользователя» — и получает его через `ref.watch(...)`.
- **Польза:**
  1. Не надо вручную передавать данные через конструкторы.
  2. Любое изменение данных сразу видно всем подписанным экранам.
  3. Код хранения данных (репозитории, контроллеры) отделён от UI.

### Основные «склады» (провайдеры)

| Провайдер | Где объявлен | Что даёт |
|-----------|--------------|----------|
| `authRepositoryProvider` | `lib/src/data/providers.dart` | Обёртка над API авторизации |
| `authControllerProvider` | `lib/src/features/auth/auth_controller.dart` | Текущее состояние пользователя (загружается, ошибка, данные) |
| `excursionsFutureProvider` | `lib/src/data/providers.dart` | Список экскурсий с сервера |
| `bookingsFutureProvider` | `lib/src/data/providers.dart` | Забронированные места пользователя |
| `Navigator.pop` (возврат значений) | Любой экран, вызывающий `Navigator.pop(result)` | Возвращает `result` в `await showDialog/ push` — используется, например, в `SellerHomePage._promptSeatNumbers`, где `Navigator.pop(controller.text)` отдаёт введённые номера мест обратно в `_book` |

Экран просто делает `ref.watch(нужныйПровайдер)` и получает данные. Если данные ещё грузятся — Riverpod даст состояние «loading», если пришла ошибка — состояние «error».

## Что такое AppShell

- Файл: `lib/src/features/common/app_shell.dart`.
- Это «точка входа» приложения после загрузки `BookingApp`.
- Поведение:
  1. Подписывается на состояние авторизации (`ref.watch(authControllerProvider)`).
  2. Пока состояние загружается — показывает крутилку.
  3. При ошибке — сообщение и кнопку «Вернуться к входу» (вызывает `signOut`).
  4. Если пользователь **не авторизован** — показывает `LoginScreen`.
  5. Если пользователь **авторизован**:
     - проверяет роль;
     - для админа — `AdminHomePage` (макет с табами и заглушками);
     - для продавца — `SellerHomePage` (интегрированная работа с API экскурсий и бронирования).

### Зачем нужен AppShell

- Централизует маршрутизацию по ролям.
- Позволяет иметь один «наблюдатель» за авторизацией, не усложняя каждый экран.
- Обеспечивает корректный переход после входа/выхода (стейт Riverpod меняется — AppShell сам перестраивает дерево виджетов).

## Итог

- Riverpod = провайдеры + контроллеры → управляют состоянием и передачей данных в UI.
- AppShell = главный «коммутатор», который решает, какой экран показывать в зависимости от состояния и роли пользователя.
